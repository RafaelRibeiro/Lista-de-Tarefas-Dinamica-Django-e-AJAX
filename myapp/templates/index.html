{% extends 'base.html' %} <!-- Herda o template base.html -->

{% block title %}Pagina 1{% endblock %} <!-- Define o t√≠tulo da aba do navegador -->

{% block content %} <!-- In√≠cio do bloco de conte√∫do da p√°gina -->

<h2>Pagina 1</h2> <!-- Cabe√ßalho da p√°gina -->

<div class="p-5"> <!-- Div container com padding -->

    <!-- Formul√°rio para adicionar novo item -->
    <form class="d-flex gap-4 col-md-6" method="POST"> <!-- Formul√°rio em linha com espa√ßamento -->
        {% csrf_token %} <!-- Token de prote√ß√£o contra CSRF -->
        <button type="submit" class="btn btn-success"> <!-- Bot√£o de adicionar item -->
            <i class="fa fa-plus"></i> <!-- √çcone de mais dentro do bot√£o -->
        </button>
        {{form}} <!-- Campo de formul√°rio gerado automaticamente (provavelmente um input de texto) -->
    </form> <!-- Fim do formul√°rio -->

    <!-- Tabela que lista os itens -->
    <table class="table"> <!-- In√≠cio da tabela -->
        <thead> <!-- Cabe√ßalho da tabela -->
            <tr> <!-- Linha do cabe√ßalho -->
                <th scope="col">Titulo</th> <!-- Coluna t√≠tulo -->
                <th scope="col">Status</th> <!-- Coluna status -->
                <th scope="col">Deletar</th> <!-- Coluna deletar -->
            </tr>
        </thead>

        <!-- Loop que percorre cada item da lista 'todo' -->
        {% for el in todo %}
        <tbody> <!-- Corpo da tabela -->
            <tr class="table align-middle" id="{{el.id}}"> <!-- Linha da tabela com ID √∫nico do item -->

                <!-- Coluna do t√≠tulo -->
                <th scope="row">
                    <!-- Div que exibe o t√≠tulo atual -->
                    <div class="title" id="title{{el.id}}" data-title="{{el.id}}">
                        {{el.title}} <!-- Exibe o texto do t√≠tulo -->
                    </div>

                    <!-- Formul√°rio oculto para editar o t√≠tulo -->
                    <form class="d-none d-flex" id="form-title{{el.id}}" method="GET" style="width:35rem;">
                        <input class="form-control" type="text" id="inputText{{el.id}}" value="{{el.title}}"> <!-- Campo de texto preenchido com o t√≠tulo atual -->
                        <button type="submit" class="btn" id="edit{{el.id}}"> <!-- Bot√£o de salvar edi√ß√£o -->
                            <i class="fa fa-edit link-warning"></i> <!-- √çcone de edi√ß√£o -->
                        </button>
                    </form>
                </th>

                <!-- Coluna de status -->
                <th scope="row">
                    {{el.status}} <!-- Mostra o status atual em texto -->

                    <!-- Dropdown para alterar o status -->
                    <div class="SelDiv">
                        <select class="form-select" name="status" id="{{el.id}}"> <!-- Select com ID do item -->
                            {% for st in status_list %} <!-- Loop nos status dispon√≠veis -->
                                <option value="{{st.id}}" 
                                    {% if el.status.id == st.id %}selected{% endif %}> <!-- Define o status atual como selecionado -->
                                    {{st.name}} <!-- Nome do status -->
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </th>

                <!-- Coluna de deletar -->
                <th scope="row">
                    <a class="btn" id="btn-delete" data-delete="{{el.id}}"> <!-- Bot√£o de deletar com data-id -->
                        <i class="fa fa-trash link-danger"></i> <!-- √çcone de lixeira -->
                    </a>
                </th>
            </tr> <!-- Fim da linha -->
        </tbody>
        {% endfor %} <!-- Fim do loop -->
    </table> <!-- Fim da tabela -->

</div> <!-- Fim do container -->

{% endblock %} <!-- Fim do bloco de conte√∫do -->


{% block scripts %} <!-- Bloco espec√≠fico para scripts JavaScript -->

<!-- Importa√ß√£o do SweetAlert2 para alertas -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="text/javascript"> 

    // ================================
    // üîß Fun√ß√£o para editar o t√≠tulo
    // ================================

    $("div.title").click(function () { // Quando o usu√°rio clica no t√≠tulo
        const data_id = $(this).attr("data-title"); // Pega o ID do item clicado

        // Mostra o formul√°rio de edi√ß√£o do t√≠tulo
        $("form#form-title" + data_id).removeClass('d-none');

        // Esconde a div que exibe o t√≠tulo atual
        $("div#title" + data_id).addClass('d-none');

        // Ao clicar no bot√£o de editar (salvar)
        $('button#edit' + data_id).on("click", function (e) {
            e.preventDefault(); // Evita que o formul√°rio recarregue a p√°gina

            const title = $('input#inputText' + data_id).val(); // Captura o novo valor digitado no input

            // Envia os dados via AJAX para atualizar o t√≠tulo no backend
            $.ajax({
                type: 'GET', // M√©todo GET (poderia ser POST para mais seguran√ßa)
                url: '{% url "update-item" %}', // URL Django para tratar atualiza√ß√£o de item
                data: {
                    'data_id': data_id, // ID do item
                    'title': title, // Novo t√≠tulo
                },
                datatype: "json", // Tipo de dado esperado
                success: function (data) { // Fun√ß√£o que executa se a requisi√ß√£o for bem-sucedida
                    if (data.status == "update-item") { // Se o backend retornar sucesso
                        // Esconde o formul√°rio de edi√ß√£o
                        $("form#form-title" + data_id).addClass('d-none');
                        // Mostra novamente o t√≠tulo atualizado
                        $("div#title" + data_id).removeClass('d-none');
                        // Atualiza o conte√∫do da div com o novo t√≠tulo
                        $("#title" + data_id).html(data.title);

                        // ‚úÖ Alerta de sucesso usando SweetAlert2
                        Swal.fire({
                            icon: 'success', // √çcone verde de sucesso
                            title: 'T√≠tulo atualizado!', // Mensagem
                            showConfirmButton: false, // Sem bot√£o OK
                            timer: 1500 // Dura 1.5 segundos
                        });
                    }
                }
            });
        });
    });


    // =================================
    // üîß Fun√ß√£o para atualizar o status
    // =================================

    $("div.SelDiv select").on('change', function () { // Ao mudar o valor do select
        const data_id = this.id; // ID do item sendo alterado
        const status_id = $(this).find('option').filter(':selected').val(); // ID do novo status selecionado

        // Envia via AJAX a altera√ß√£o de status
        $.ajax({
            type: 'GET', // M√©todo GET
            url: '{% url "update-status" %}', // URL Django que recebe o update
            data: {
                'data_id': data_id, // ID do item
                'status_id': status_id, // Novo status
            },
            datatype: "json", // Tipo esperado
            success: function (data) { // Se der certo
                // ‚úÖ Alerta visual de que o status foi alterado
                Swal.fire({
                    icon: 'success',
                    title: 'Status atualizado!',
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        });
    });


    // =================================
    // ‚ùå Fun√ß√£o para deletar um item
    // =================================

    $(document).on("click", "a#btn-delete", function (e) { // Ao clicar no bot√£o deletar
        e.preventDefault(); // Impede o comportamento padr√£o (como navegar no link)

        const todo_id = $(this).attr("data-delete"); // Captura o ID do item a ser deletado

        // Alerta de confirma√ß√£o antes de deletar
        Swal.fire({
            title: 'Tem certeza?', // T√≠tulo do alerta
            text: "Voc√™ n√£o poder√° desfazer essa a√ß√£o!", // Texto de aviso
            icon: 'warning', // √çcone de aviso
            showCancelButton: true, // Mostra bot√£o de cancelar
            confirmButtonColor: '#d33', // Cor do bot√£o confirmar (vermelho)
            cancelButtonColor: '#3085d6', // Cor do bot√£o cancelar (azul)
            confirmButtonText: 'Sim, deletar!', // Texto do bot√£o confirmar
            cancelButtonText: 'Cancelar' // Texto do bot√£o cancelar
        }).then((result) => { // Quando o usu√°rio escolhe uma op√ß√£o
            if (result.isConfirmed) { // Se ele clicou em confirmar
                // Envia AJAX para deletar
                $.ajax({
                    type: 'GET',
                    url: '{% url "delete" %}', // URL Django que deleta
                    data: { 'todo_id': todo_id }, // Envia ID do item
                    datatype: "json",
                    success: function (data) { // Se deu certo
                        if (data.status == "delete") { // Confirma√ß√£o do backend
                            // Remove visualmente a linha da tabela
                            $("tbody tr#" + todo_id).fadeOut("slow", function () {
                                $(this).remove(); // Remove do DOM
                            });

                            // ‚úÖ Alerta de que foi deletado
                            Swal.fire(
                                'Deletado!', // T√≠tulo
                                'O item foi removido com sucesso.', // Texto
                                'success' // √çcone
                            );
                        }
                    }
                });
            }
        });
    });

</script> 
{% endblock %} <!-- Fim do bloco de scripts -->
